# Consuming SMART Health Links

This guide covers decoding a `shlink:/` URL, fetching the manifest, and decrypting the FHIR content — the viewer side of the SHL protocol.

**Prerequisites:** You've [created an SHL](./guide-create.md) and [set up a server](./guide-serve.md) to serve it.

---

## Step 1: Decode the URL

Every `shlink:/` URL encodes a base64url JSON payload containing the manifest endpoint, encryption key, and flags.

```typescript
import { SHL } from "@fhirfly-io/shl";

const decoded = SHL.decode(shlUrl);

console.log(decoded.url);   // manifest endpoint (e.g., "http://localhost:3000/shl/{id}")
console.log(decoded.key);   // base64url-encoded 256-bit encryption key
console.log(decoded.flag);  // "LP" (L = manifest mode, P = passcode required)
console.log(decoded.label); // "Maria Garcia — Patient Summary"
```

### Flags

| Flag | Meaning |
|------|---------|
| `L` | Long-lived manifest mode (data on a server) |
| `P` | Passcode required |
| `U` | Single-use (one access only) |

Most SHLs created by this SDK will have `LP` (manifest mode + passcode).

---

## Step 2: Fetch the manifest

POST to the manifest URL with the passcode (if the `P` flag is set):

```typescript
const manifest = await fetch(decoded.url, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ passcode: "1234" }),
}).then(r => r.json());

console.log(manifest.files);
// [{ contentType: "application/fhir+json", location: "http://..." }]
```

The manifest contains a `files` array. Each entry has a `contentType` and `location` URL for the encrypted content.

### Error responses

| Status | Meaning |
|--------|---------|
| 200 | Success — manifest returned |
| 401 | Wrong or missing passcode |
| 404 | SHL ID not found |
| 410 | SHL expired or access limit reached |

---

## Step 3: Fetch the encrypted content

GET the encrypted file from the location in the manifest:

```typescript
const jwe = await fetch(manifest.files[0].location).then(r => r.text());
```

The response is a JWE (JSON Web Encryption) compact serialization string — an opaque encrypted blob.

---

## Step 4: Decrypt

Use the key from the decoded URL to decrypt the JWE back to a FHIR Bundle:

```typescript
const decrypted = SHL.decrypt(jwe, decoded.key);

console.log(decrypted.resourceType); // "Bundle"
console.log(decrypted.type);         // "document"
console.log(decrypted.entry.length); // Number of resources in the bundle
```

The `decrypted` object is the original FHIR R4 IPS Bundle — identical to what was passed to `SHL.create()`.

**Checkpoint:** `decrypted` is identical to the original `fhirBundle` you built in the [creation guide](./guide-create.md).

---

## Complete example

Putting it all together — a full round-trip verification:

```typescript
import { SHL } from "@fhirfly-io/shl";

// Assume `shlUrl` is the shlink:/ URL from SHL.create()
const decoded = SHL.decode(shlUrl);

// Fetch manifest
const manifest = await fetch(decoded.url, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ passcode: "1234" }),
}).then(r => r.json());

// Fetch and decrypt
const jwe = await fetch(manifest.files[0].location).then(r => r.text());
const bundle = SHL.decrypt(jwe, decoded.key);

// Verify
console.log(bundle.resourceType); // "Bundle"
console.log(bundle.type);         // "document"

// Extract patient info
const patient = bundle.entry.find(
  (e: any) => e.resource?.resourceType === "Patient"
)?.resource;
console.log(patient?.name?.[0]?.given?.[0]); // "Maria"
console.log(patient?.name?.[0]?.family);      // "Garcia"
```

---

## Building a viewer app

To build a viewer application that scans QR codes and displays patient data:

1. **Scan the QR code** — use a camera/QR scanner library to get the `shlink:/` URL
2. **Decode** — `SHL.decode(url)` extracts the manifest endpoint and key
3. **Prompt for passcode** — if `decoded.flag` includes `P`, ask the user for the passcode
4. **Fetch and decrypt** — as shown above
5. **Render the FHIR data** — parse the Bundle entries and display medications, conditions, etc.

For testing, you can use the [CommonHealth SHL Viewer](https://viewer.commonhealth.org/) to scan QR codes generated by the SDK.

---

## Reference

- [SMART Health Links Specification](https://docs.smarthealthit.org/smart-health-links/spec/)
- [IPS Implementation Guide](https://build.fhir.org/ig/HL7/fhir-ips/)
- [CommonHealth SHL Viewer](https://viewer.commonhealth.org/)
